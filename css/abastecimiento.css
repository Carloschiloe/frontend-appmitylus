/* =========================================
   ABASTECIMIENTO – Overrides sobre global
   ========================================= */

/* ======= TABLAS: Contactos + Visitas ======= */

/* Cabezal teal */
#tablaContactos.dataTable thead th,
#tablaVisitas.dataTable thead th {
  background: var(--primary) !important;
  color: #fff !important;
}

/* Densidad de filas */
#tablaContactos th, #tablaContactos td,
#tablaVisitas  th, #tablaVisitas  td {
  font-size: 0.92rem;
  padding: 0.38rem 0.5rem;
  border-bottom: 1px solid #e0e0e0;
}

/* Acciones (íconos) */
#tablaContactos td .material-icons,
#tablaVisitas  td .material-icons {
  font-size: 1.22em;
  margin-right: 8px;
  transition: transform .12s ease, color .12s ease;
}
#tablaContactos td .material-icons:hover,
#tablaVisitas  td .material-icons:hover {
  color: var(--primary-acc);
  transform: scale(1.08);
}

/* ======= BOTONES / TOOLBAR ======= */
#btnOpenContactoModal{ margin:.25rem 0 .5rem 0; }

/* ======= MODALES ======= */
/* Contacto y Detalle */
#modalContacto.modal,
#modalDetalleContacto.modal {
  max-width: 760px !important;
  max-height: 86vh !important;
  top: 7vh !important;
}
#modalContacto .modal-content,
#modalDetalleContacto .modal-content {
  max-height: 72vh !important;
}
#modalContacto .modal-footer,
#modalDetalleContacto .modal-footer {
  padding: .5rem .75rem !important;
}

/* Visita (mismo look) */
#modalVisita.modal {
  max-width: 760px !important;
  max-height: 86vh !important;
  top: 7vh !important;
}
#modalVisita .modal-content {
  max-height: 72vh !important;
}
#modalVisita .modal-footer {
  padding: .5rem .75rem !important;
}

/* Inputs más compactos dentro de los modales */
#modalContacto .input-field input,
#modalContacto .input-field select,
#modalContacto .input-field textarea,
#modalVisita   .input-field input,
#modalVisita   .input-field select,
#modalVisita   .input-field textarea {
  margin-bottom: .6rem;
}

/* ======= RESPONSIVE ======= */
@media (max-width: 992px){
  #tablaContactos, #tablaContactos_wrapper,
  #tablaVisitas,  #tablaVisitas_wrapper {
    min-width: 360px !important;
    width: 100vw !important;
    display: block !important;
  }
  .dataTables_paginate{ justify-content:center; }
}
@media (max-width: 600px){
  #modalContacto.modal,
  #modalDetalleContacto.modal,
  #modalVisita.modal {
    width: 96% !important;
    top: 4vh !important;
  }
  #tablaContactos th, #tablaContactos td,
  #tablaVisitas  th, #tablaVisitas  td {
    font-size: .88rem;
    padding: .34rem .45rem;
  }
}

/* ======= SELECT nativo con look Materialize en modales ======= */
.modal .browser-default {
  width: 100%;
  background: transparent;
  border: none;
  border-bottom: 1px solid #9e9e9e;
  padding: 8px 0 6px;
  font-size: 16px;
}
.modal .browser-default:focus {
  outline: none;
  border-bottom: 2px solid #26a69a;
}
.modal .input-field label.active {
  transform: none !important;
  font-size: 0.9rem;
  color: #9e9e9e;
  margin-bottom: 2px;
  display: block;
}

/* === Alinea el modal de MMPP con tus otros modales === */
#modalBloque.modal {
  max-width: 760px !important;
  max-height: 86vh !important;
  top: 7vh !important;
}
#modalBloque .modal-content { max-height: 72vh !important; }
#modalBloque .modal-footer  { padding: .5rem .75rem !important; }

/* Z-index alto por si DataTables / charts crean stacking contexts */
.modal         { z-index: 1005 !important; }
.modal-overlay { z-index: 1004 !important; }

/* Evita que contenedores tapen el overlay por overflow/transform */
.container, .card-panel { overflow: visible !important; }

/* =========================================
   PLANIFICACIÓN – Complementos sin duplicados
   ========================================= */

/* Utilidades generales */
.mt-12{margin-top:12px}
.mt-14{margin-top:14px}
.mt-18{margin-top:18px}
.mb-32{margin-bottom:32px}
.hidden{display:none!important}
.static-label{transform:none!important;font-size:.9rem;color:#9e9e9e}

/* Barras de progreso compactas (KPIs y realtime) */
.progress.slim{height:8px;border-radius:8px;margin:.4rem 0 0}
.progress .determinate{border-radius:8px}

/* KPIs (grid responsive) */
.kpi-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:14px;margin:14px 0 6px}
.kpi{grid-column:span 12;background:#fff;border-radius:14px;padding:16px 18px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
.kpi h6{margin:0;font-size:.95rem;color:#546e7a;font-weight:600}
.kpi .val{font-size:1.6rem;font-weight:700;margin-top:4px;color:#004d40}
.kpi .sub{font-size:.9rem;color:#78909c;margin-top:2px}
@media(min-width:600px){.kpi{grid-column:span 6}}
@media(min-width:992px){.kpi{grid-column:span 3}}

/* Toolbar / filtros */
.toolbar-panel{padding:14px 16px}
.toolbar{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;align-items:end}
.toolbar .input-field{margin:0}
.toolbar .actions{grid-column:span 12;display:flex;gap:8px;justify-content:flex-end}
.toolbar .toggles{display:flex;gap:16px;align-items:center}
.periodo-wrap{display:flex;gap:10px;align-items:end}
.periodo-nav{display:flex;gap:6px;align-items:center}
.btn-ghost{background:transparent!important}
@media(min-width:600px){
  .toolbar .w2{grid-column:span 2}
  .toolbar .w3{grid-column:span 3}
  .toolbar .w4{grid-column:span 4}
  .toolbar .w5{grid-column:span 5}
  .toolbar .w6{grid-column:span 6}
  .toolbar .w12{grid-column:span 12}
}
@media(min-width:992px){
  .toolbar .w2{grid-column:span 2}
  .toolbar .w3{grid-column:span 3}
  .toolbar .w4{grid-column:span 4}
  .toolbar .w5{grid-column:span 5}
  .toolbar .w6{grid-column:span 6}
}

/* Tablas planificación */
#tablaProgramaSemanal.dataTable thead th{
  background: var(--primary) !important;
  color: #fff !important;
}
#tablaProgramaSemanal td.right-align{ text-align:right }

/* Tarjetas de gráfico / tablero */
.chart-card{background:#fff;border-radius:14px;padding:14px 16px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
.chart-card .chart-title{margin:0 0 8px}

/* Realtime list (últimos 5 abastecimientos) */
.rt-list{margin:0;list-style:none;display:grid;gap:8px}
.rt-list .progress{margin:.25rem 0 0}

/* Gantt mensual liviano */
.gantt{display:grid;gap:8px}
.gantt__row{display:grid;grid-template-columns:110px 1fr;align-items:center;gap:8px}
.gantt__label{font-size:.9rem;color:#607d8b}
.gantt__track{position:relative;height:20px;background:#eceff1;border-radius:10px;overflow:hidden}
.gantt__bar{position:absolute;top:0;bottom:0;border-radius:10px}
.gantt__bar--meta{left:0;right:0;border:2px dashed #90a4ae;background:transparent}
.gantt__bar--plan{left:0;width:0;background:#64b5f6}
.gantt__bar--real{left:0;width:0;background:#66bb6a;opacity:.9}

/* Impresión (oculta UI y limpia tarjetas) */
@media print{
  nav, .tabs, .actions, .modal, .toolbar-panel .input-field{ display:none !important; }
  .kpi-grid{ grid-template-columns:repeat(4,1fr)!important }
  .chart-card{ box-shadow:none!important; border:1px solid #eee }
}

// /js/contactos/tabla.js
import { state, $ } from './state.js';
import { abrirEdicion, eliminarContacto } from './form-contacto.js';
import { abrirDetalleContacto, abrirModalVisita } from './visitas.js';

let dt = null;

export function initTablaContactos() {
  const jq = window.jQuery || window.$;
  const tabla = document.getElementById('tablaContactos');
  if (!tabla || (dt && jq)) return;

  if (jq) {
    dt = jq('#tablaContactos').DataTable({
      dom: 'Bfrtip',
      buttons: [
        { extend:'excelHtml5', title:'Contactos_Abastecimiento' },
        { extend:'pdfHtml5',   title:'Contactos_Abastecimiento', orientation:'landscape', pageSize:'A4' }
      ],
      order: [[0,'desc']],
      pageLength: 10,                 // ← 10 por página
      autoWidth: false,
      fixedHeader: true,              // ← cabecera fija sin desalinearse
      language: { url:'https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json' },
      columnDefs: [
        { targets: 0, width: '110px' },       // Fecha
        { targets: 1, width: '220px' },       // Contacto
        { targets: 2, width: '150px' },       // Teléfono
        { targets: 3, width: '220px' },       // Email
        { targets: 4, width: '220px', className:'col-empresa' }, // Empresa (más angosta)
        { targets: 5, width: '320px', className:'col-notas' },   // Notas (más angosta)
        { targets: -1, orderable:false, searchable:false, width:'150px' } // Acciones
      ]
    });

    // Acciones
    jq('#tablaContactos tbody')
      .on('click', 'a.icon-action.ver', function(){
        const id = this.dataset.id;
        const c = state.contactosGuardados.find(x => String(x._id) === String(id));
        if (c) abrirDetalleContacto(c);
      })
      .on('click', 'a.icon-action.visita', function(){
        const id = this.dataset.id;
        const c = state.contactosGuardados.find(x => String(x._id) === String(id));
        if (c) abrirModalVisita(c);
      })
      .on('click', 'a.icon-action.editar', function(){
        const id = this.dataset.id;
        const c = state.contactosGuardados.find(x => String(x._id) === String(id));
        if (c) abrirEdicion(c);
      })
      .on('click', 'a.icon-action.eliminar', async function(){
        const id = this.dataset.id;
        if (!confirm('¿Seguro que quieres eliminar este contacto?')) return;
        try {
          await eliminarContacto(id);
          renderTablaContactos();
        } catch(e){
          console.error(e);
          M.toast?.({ html:'No se pudo eliminar', displayLength:2000 });
        }
      })
      // Asociar/Cambiar empresa: ahora en Acciones con ícono 🏢
      .on('click', 'a.icon-action.asociar', function(e){
        e.preventDefault();
        const id = this.dataset.id;
        state.asociarContactoId = id;
        try { document.dispatchEvent(new CustomEvent('asociar-open', { detail:{ contactoId:id } })); } catch {}
        const modal = document.getElementById('modalAsociar');
        if (modal && window.M && M.Modal) {
          const inst = M.Modal.getInstance(modal) || M.Modal.init(modal, {});
          // limpiar buscador
          const inp = document.getElementById('empresaSearch');
          const ul  = document.getElementById('searchResults');
          if (inp) inp.value = '';
          if (ul)  ul.innerHTML = '';
          inst.open();
        }
      });
  }

  // refrescar cuando cambie el filtro o cuando se recarguen contactos
  document.addEventListener('reload-tabla-contactos', ()=> renderTablaContactos());

  renderTablaContactos();
}

export function renderTablaContactos() {
  const jq = window.jQuery || window.$;
  const lista = (state.contactosGuardados || []).slice()
    .sort((a,b)=>{
      const da = new Date(a.createdAt || a.fecha || 0).getTime();
      const db = new Date(b.createdAt || b.fecha || 0).getTime();
      return db - da;
    });

  const filas = lista.map(c=>{
    const f = new Date(c.createdAt || c.fecha || Date.now());
    const yyyy = f.getFullYear();
    const mm = String(f.getMonth()+1).padStart(2,'0');
    const dd = String(f.getDate()).padStart(2,'0');
    const whenDisplay = `${yyyy}-${mm}-${dd}`;
    const whenKey = f.getTime();

    const tel = Array.isArray(c.contactoTelefonos) ? c.contactoTelefonos.join(' / ') : (c.contactoTelefono || '');
    const mail = Array.isArray(c.contactoEmails) ? c.contactoEmails.join(' / ') : (c.contactoEmail || '');

    // EMPRESA: solo chip con el nombre (ellipsis + title), sin “CAMBIAR”
    const nombreEmpresa = c.proveedorNombre || c.empresaNombre || '';
    const empresaHTML = c.proveedorKey
      ? `<span class="chip empresa-chip ellipsis" title="${esc(nombreEmpresa)}">${esc(nombreEmpresa)}</span>`
      : `<span class="new badge red" data-badge-caption="" title="Sin empresa">Sin empresa</span>`;

    // NOTAS: ellipsis + title
    const nota = c.notas || c.notasContacto || '';
    const notasHTML = `<span class="ellipsis" title="${esc(nota)}">${esc(nota)}</span>`;

    const acciones = `
      <a href="#!" class="icon-action ver" title="Ver detalle" data-id="${c._id}"><i class="material-icons">visibility</i></a>
      <a href="#!" class="icon-action visita" title="Registrar visita" data-id="${c._id}"><i class="material-icons">event_available</i></a>
      <a href="#!" class="icon-action asociar" title="Asociar/Cambiar empresa" data-id="${c._id}"><i class="material-icons">business</i></a>
      <a href="#!" class="icon-action editar" title="Editar" data-id="${c._id}"><i class="material-icons">edit</i></a>
      <a href="#!" class="icon-action eliminar" title="Eliminar" data-id="${c._id}"><i class="material-icons">delete</i></a>
    `;

    return [
      `<span data-order="${whenKey}">${whenDisplay}</span>`,
      esc(c.contactoNombre || c.proveedorNombre || ''),
      esc(String(tel)),
      esc(String(mail)),
      empresaHTML,
      notasHTML,
      acciones
    ];
  });

  if (dt && jq) {
    dt.clear();
    dt.rows.add(filas).draw();
    return;
  }

  const tbody = $('#tablaContactos tbody');
  if (!tbody) return;

  tbody.innerHTML = '';
  if (!lista.length) {
    tbody.innerHTML = `<tr><td colspan="7" style="color:#888">No hay contactos aún.</td></tr>`;
    return;
  }
  filas.forEach(arr=>{
    const tr = document.createElement('tr');
    tr.innerHTML = arr.map(td=>`<td>${td}</td>`).join('');
    tbody.appendChild(tr);
  });
}

function esc(s=''){
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

