import { Estado } from '../../core/estado.js';
import { getCentrosAll } from '../../core/centros_repo.js';
import { initConteoRapido, abrirConteoLinea } from './conteo_rapido.js';

let dtHist = null;
let dtUltimos = null;
let ultimosData = [];

// Filtros actuales
const F = { estadoLinea: 'all', kpi: null };

// Helper para formatear fecha a DD-MM-YYYY
const fechaSolo = iso => {
  if (!iso) return '-';
  const d = new Date(iso);
  return d.toLocaleDateString('es-CL', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric'
  });
};

// Inicialización principal
document.addEventListener('DOMContentLoaded', async () => {
  M.AutoInit();

  // Cargar centros y líneas
  Estado.centros = await getCentrosAll();
  Estado.centros.forEach(c => { if (!Array.isArray(c.lines)) c.lines = []; });

  // Inicializar selecciones con Choices.js
  initChoicesSelects();

  // Inicializar conteo rápido
  initConteoRapido();
  initBotonConteo();

  // Inicializar tablas
  initTablaHistorial();
  initTablaUltimos();

  // Cargar datos y mostrar
  await refreshHistorial();
  await refreshUltimosYResumen();
  mostrarResumen();

  // Tabs con hash
  const tabs = M.Tabs.getInstance(document.getElementById('tabsLB'));
  if (window.location.hash === '#tab-historial') tabs?.select('tab-historial');
  if (window.location.hash === '#tab-ultimos')   tabs?.select('tab-ultimos');

  // Ajustar columnas al cambiar tab
  document.querySelectorAll('#tabsLB a').forEach(a => {
    a.addEventListener('click', e => {
      const href = e.currentTarget.getAttribute('href');
      setTimeout(() => {
        if (href === '#tab-historial') dtHist?.columns.adjust().draw(false);
        if (href === '#tab-ultimos')   dtUltimos?.columns.adjust().draw(false);
      }, 200);
    });
  });

  // Filtro estado línea
  const selEstado = document.getElementById('fEstadoLinea');
  selEstado?.addEventListener('change', () => {
    F.estadoLinea = selEstado.value;
    F.kpi = null;
    marcarActivos();
    aplicarFiltrosUltimos();
  });

  // Evento KPIs agrupados
  document.getElementById('kpiGroups')?.addEventListener('click', e => {
    const filter = e.target.dataset.kpi;
    if (!filter) return;
    F.kpi = (F.kpi === filter ? null : filter);
    // Sincronizar select de estado si es KPI de línea o sinInventario
    const s = document.getElementById('fEstadoLinea');
    if (['linea_buena','linea_regular','linea_mala','sinInv'].includes(filter)) {
      F.estadoLinea = filter === 'sinInv' ? 'sinInv' : 'all';
      s.value = F.estadoLinea;
      M.FormSelect.getInstance(s)?.destroy();
      M.FormSelect.init(s);
    }
    marcarActivos();
    aplicarFiltrosUltimos();
  });

  // Refrescar tras guardar inventario
  window.addEventListener('inventario-guardado', async () => {
    await refreshHistorial();
    await refreshUltimosYResumen();
    mostrarResumen();
  });
});

/**
 * Inicializa los selects de Centro y Línea usando Choices.js inyectado globalmente
 */
function initChoicesSelects() {
  const selectCentro = document.getElementById('inputCentro');
  const selectLinea  = document.getElementById('inputLinea');

  // Poblar opciones Centro
  Estado.centros.forEach((c, i) => {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = c.name;
    selectCentro.appendChild(opt);
  });

  // Instancia Choices.js a través del global
  const choicesCentro = new window.Choices(selectCentro, {
    placeholder: true,
    placeholderValue: 'Selecciona un centro',
    searchPlaceholderValue: 'Buscar centro…',
    itemSelectText: '',
    shouldSort: false
  });
  const choicesLinea = new window.Choices(selectLinea, {
    placeholder: true,
    placeholderValue: 'Selecciona una línea',
    searchPlaceholderValue: 'Buscar línea…',
    itemSelectText: '',
    shouldSort: false
  });

  // Al cambiar Centro, cargar Líneas
  selectCentro.addEventListener('change', e => {
    const idx   = parseInt(e.detail.value, 10);
    window.selectedCentroIdx = idx;
    const lines = Estado.centros[idx].lines || [];
    choicesLinea.clearChoices();
    choicesLinea.setChoices(
      lines.map((l, i) => ({ value: i, label: l.number })),
      'value', 'label', true
    );
    selectLinea.removeAttribute('disabled');
    choicesLinea.showDropdown(true);
  });

  // Guardar selección Línea
  selectLinea.addEventListener('change', e => {
    window.selectedLineaIdx = parseInt(e.detail.value, 10);
  });
}

/** Mostrar resumen del último inventario */
function mostrarResumen() {
  const cIdx = window.selectedCentroIdx;
  const lIdx = window.selectedLineaIdx;
  const cont = document.getElementById('resumenInventario');
  if (cIdx == null || lIdx == null) { cont.style.display = 'none'; return; }
  const invs = Estado.centros[cIdx].lines[lIdx].inventarios || [];
  if (!invs.length) {
    cont.style.display = 'block';
    cont.innerHTML = '<em>Sin inventarios aún</em>';
    return;
  }
  const u = invs[invs.length - 1];
  cont.style.display = 'block';
  cont.innerHTML = `
    <b>Último:</b> ${fechaSolo(u.fecha)}<br>
    Tot: ${u.boyas.total} |
    NB ${u.boyas.negras.buenas}/${u.boyas.negras.malas} |
    NA ${u.boyas.naranjas.buenas}/${u.boyas.naranjas.malas} |
    S:${u.sueltas} | Col:${u.colchas}<br>
    Estado: ${u.estadoLinea} | Obs: ${u.observaciones || '-'}
  `;
}

/** Inicializa botón de Conteo Rápido */
function initBotonConteo() {
  document.getElementById('btnAbrirConteo')
    .addEventListener('click', () => {
      const c = window.selectedCentroIdx;
      const l = window.selectedLineaIdx;
      if (c == null || l == null) {
        M.toast({ html: 'Selecciona centro y línea', classes: 'red' });
        return;
      }
      abrirConteoLinea(c, l);
    });
}

// ... (mantén intactas initTablaHistorial, refreshHistorial, initTablaUltimos, refreshUltimosYResumen,
//     aplicarFiltrosUltimos, renderKPIs, marcarActivos)
