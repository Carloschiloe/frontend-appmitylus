<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Abastecimiento de MMPP – Choritos</title>

  <!-- Google Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

  <!-- Materialize -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />

  <!-- DataTables + Buttons -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

  <!-- SPA styles -->
  <link rel="preload" href="/spa-mmpp/layout.css?v=1" as="style">
  <link rel="stylesheet" href="/spa-mmpp/layout.css?v=1">
  <link rel="stylesheet" href="/spa-mmpp/inventario.css?v=1">
  <link rel="stylesheet" href="/js/abastecimiento/visitas/fotos/styles.css">

  <style>
    /* inputs file nativos */
    .modal input[type="file"]{display:none!important}

    /* Filtros (tabla Contactos) */
    .filtros-row{
      display:grid;
      grid-template-columns: repeat(4, minmax(180px,1fr));
      gap:10px; align-items:center;
    }
    @media (max-width: 920px){ .filtros-row{ grid-template-columns: 1fr 1fr; } }
    @media (max-width: 520px){ .filtros-row{ grid-template-columns: 1fr; } }
    .filtros-row select,.filtros-row input{ height:40px; border-radius:10px; padding:4px 8px; }

    /* Contenedor con scroll horizontal externo a DataTables */
    .mmpp-table-wrap{ overflow-x:auto; }

    /* Tabla de visitas */
    #tablaVisitas{ width:100%; }
    #tablaVisitas th, #tablaVisitas td{
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      padding:10px 8px;
    }
    /* ancho mínimo y visibilidad de Acciones */
    #tablaVisitas th:last-child, #tablaVisitas td:last-child{
      min-width:180px; width:180px; overflow:visible!important;
      display: table-cell !important;
    }

    /* ===== Barra de filtros + buscador de VISITAS ===== */
    .visitas-toolbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      margin:10px 0 6px;
    }
    .visitas-filtros{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    .visitas-filtros .fld{ display:flex; align-items:center; gap:6px; }
    .visitas-filtros label{ font-size:12px; color:#6b7280; }
    .visitas-filtros select.browser-default{
      min-width:160px; padding:6px 8px; border:1px solid #e5e7eb; border-radius:8px; background:#fff;
      height:auto; line-height:normal;
    }
    .visitas-search input{
      width:260px; max-width:100%;
      height:40px; border-radius:10px; padding:4px 10px; border:1px solid #e5e7eb;
    }
  </style>
</head>
<body class="mmpp-layout no-nav">

  <main class="mmpp-main">
    <div class="mmpp-wrap">

      <!-- Header / Hero -->
      <header class="mmpp-hero" style="margin-bottom:14px">
        <div>
          <h1>Abastecimiento de MMPP</h1>
        <p>Empresas, visitas a cultivos y agenda de contactos</p>
        </div>
        <div style="display:flex; gap:10px; align-items:center;">
          <div class="mmpp-badge">
            <i class="material-icons" style="font-size:18px">inventory_2</i>
            Gestión unificada
          </div>
          <div class="mmpp-badge week-badge" id="badgeSemanaActual">
            <i class="material-icons" style="font-size:18px">event</i>
            <span>Semana —</span>
          </div>
        </div>
      </header>

      <!-- Tabs -->
      <div class="card" style="padding:0; margin-bottom:12px">
        <ul id="tabs" class="tabs" style="padding:0 12px">
          <li class="tab col s4"><a class="active" href="#tab-contactos">Empresas</a></li>
          <li class="tab col s4"><a href="#tab-visitas">Visitas a Cultivos</a></li>
          <li class="tab col s4"><a href="#tab-personas">Agenda de Contactos</a></li>
        </ul>
      </div>

      <!-- EMPRESAS -->
      <section id="tab-contactos" class="col s12">
        <div class="mmpp-card" style="margin-bottom:12px">
          <!-- Toolbar -->
          <div class="table-toolbar" style="display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap">
            <div class="left" style="display:flex;gap:8px;flex-wrap:wrap">
              <button id="btnOpenContactoModal" class="mmpp-add">
                <i class="material-icons left" style="font-size:18px">record_voice_over</i>
                Registrar contacto
              </button>
            </div>
            <!-- Filtros + buscador -->
            <div id="filtrosContactos" class="filtros-row" style="min-width:620px;flex:1">
              <select id="fltSemana" class="browser-default modern-select" aria-label="Filtrar por semana">
                <option value="">Semana…</option>
              </select>
              <select id="fltComuna" class="browser-default modern-select" aria-label="Filtrar por comuna">
                <option value="">Comuna…</option>
              </select>
              <select id="fltResp" class="browser-default modern-select" aria-label="Filtrar por responsable">
                <option value="">Responsable…</option>
                <option>Claudio Alba</option>
                <option>Patricio Alvarez</option>
                <option>Carlos Avendaño</option>
              </select>
              <input id="searchContactos" class="mmpp-input" placeholder="Buscar…" aria-label="Buscar en la tabla">
            </div>
          </div>

          <!-- Tabla Contactos -->
          <!-- Tabla Contactos -->
<div class="mmpp-table-wrap">
  <table id="tablaContactos" class="display mmpp" style="width:100%">
    <thead>
      <tr>
        <th>Semana</th>
        <th>Fecha</th>
        <th>Proveedor</th>
        <th>Centro</th>       <!-- La comuna va debajo del centro -->
        <th>Tons</th>
        <th>Responsable</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

        </div>
      </section>

      <!-- VISITAS -->
      <section id="tab-visitas" class="col s12">
        <div class="mmpp-card" style="margin-bottom:12px">
          <div class="muted" style="margin-bottom:8px">
            Revisión, filtros y exportación de visitas (la creación sigue en Contactos).
          </div>

          <!-- ===== Toolbar de VISITAS: filtros (semana/comuna) + buscador ===== -->
          <div class="visitas-toolbar">
            <div id="visitas-filtros-bar" class="visitas-filtros">
              <div class="fld">
                <label for="fltVisSem">Semana</label>
                <select id="fltVisSem" class="browser-default" aria-label="Filtrar por semana">
                  <option value="">Todas</option>
                </select>
              </div>
              <div class="fld">
                <label for="fltVisComuna">Comuna</label>
                <select id="fltVisComuna" class="browser-default" aria-label="Filtrar por comuna">
                  <option value="">Todas</option>
                </select>
              </div>
            </div>
            <div class="visitas-search">
              <input id="searchVisitas" type="text" placeholder="Buscar en visitas…" aria-label="Buscar en la tabla de visitas">
            </div>
          </div>
          <!-- ===== /Toolbar de VISITAS ===== -->

          <div class="mmpp-table-wrap">
            <table id="tablaVisitas" class="display mmpp" style="width:100%">
              <thead>
                <tr>
                  <th>Sem.</th>
                  <th>Fecha</th>
                  <th>Proveedor</th>
                  <th>Centro</th>
                  <th>Próximo paso</th>
                  <th>Fecha prox.</th>
                  <th>Tons</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- AGENDA DE CONTACTOS -->
      <section id="tab-personas" class="col s12">
        <div class="mmpp-card" style="margin-bottom:12px">
          <div class="table-toolbar">
            <div class="left" style="display:flex;gap:8px;flex-wrap:wrap">
              <button id="btnOpenPersonaModal" class="mmpp-add">
                <i class="material-icons left" style="font-size:18px">person_add</i>
                Registrar persona
              </button>
            </div>
            <div class="right">
              <div class="search">
                <input id="searchPersonas" class="mmpp-input" placeholder="Buscar…">
              </div>
            </div>
          </div>

          <div class="mmpp-table-wrap">
            <table id="tablaPersonas" class="display mmpp" style="width:100%">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Contacto</th>
                  <th>Teléfono(s)</th>
                  <th>Email</th>
                  <th>Comuna</th>
                  <th>Empresa</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- MODAL CONTACTO -->
      <div id="modalContacto" class="modal">
        <div class="modal-content">
          <h5>Registrar Contacto</h5>

          <div class="input-field" style="position:relative;">
            <input type="text" id="buscadorProveedor" list="datalistProveedores" placeholder="Nombre o apellido del proveedor..." autocomplete="off">
            <label for="buscadorProveedor">Proveedor</label>
            <datalist id="datalistProveedores"></datalist>
          </div>

          <div class="input-field">
            <label for="selectCentro" class="active">Centro</label>
            <select id="selectCentro" class="browser-default modern-select" disabled>
              <option value="" disabled selected>Selecciona un centro (opcional)</option>
            </select>
          </div>

          <input type="hidden" id="proveedorId">
          <input type="hidden" id="proveedorNombre">
          <input type="hidden" id="proveedorKey">
          <input type="hidden" id="centroId">
          <input type="hidden" id="centroCodigo">
          <input type="hidden" id="centroComuna">
          <input type="hidden" id="centroHectareas">

          <form id="formContacto" autocomplete="off">
            <div class="row">
              <!-- Eliminado “tiene MMPP” -->
              <div class="input-field col s6">
                <label for="contactoResponsable" class="active">Responsable PG</label>
                <select id="contactoResponsable" class="browser-default modern-select">
                  <option value="">—</option>
                  <option value="Claudio Alba">Claudio Alba</option>
                  <option value="Patricio Alvarez">Patricio Alvarez</option>
                  <option value="Carlos Avendaño">Carlos Avendaño</option>
                </select>
              </div>

              <div class="input-field col s6">
                <input id="vendeActualmenteA" type="text" placeholder="Ej: Camanchaca, Orizon...">
                <label for="vendeActualmenteA">Vende actualmente a</label>
              </div>
            </div>

            <div class="row">
              <div class="input-field col s4">
                <input id="contactoNombre" type="text" placeholder="Nombre y apellido">
                <label for="contactoNombre">Nombre del contacto</label>
              </div>

              <div class="input-field col s4">
                <input id="contactoTelefono" type="tel" placeholder="+56 9 1234 5678">
                <label for="contactoTelefono">Teléfono</label>
              </div>

              <div class="input-field col s4">
                <input id="contactoEmail" type="email" placeholder="correo@dominio.cl">
                <label for="contactoEmail">Email</label>
              </div>
            </div>

            <!-- DISPONIBILIDAD MMPP (asignaciones) -->
            <div class="row" id="asigDisponibilidadBlock">
              <div class="col s12"><h6 class="grey-text text-darken-2" style="margin:4px 0 8px">Disponibilidad de MMPP (asignaciones)</h6></div>

              <div class="col s12 m4">
                <div class="input-field">
                  <input id="asigAnio" type="number" min="2020" max="2100">
                  <label for="asigAnio">Año</label>
                </div>
              </div>

              <div class="col s12 m4">
                <div class="input-field">
                  <select id="asigMes">
                    <option value="" selected>Mes…</option>
                    <option value="1">Enero</option>
                    <option value="2">Febrero</option>
                    <option value="3">Marzo</option>
                    <option value="4">Abril</option>
                    <option value="5">Mayo</option>
                    <option value="6">Junio</option>
                    <option value="7">Julio</option>
                    <option value="8">Agosto</option>
                    <option value="9">Septiembre</option>
                    <option value="10">Octubre</option>
                    <option value="11">Noviembre</option>
                    <option value="12">Diciembre</option>
                  </select>
                  <label for="asigMes">Mes</label>
                </div>
              </div>

              <div class="col s12 m4">
                <div class="input-field">
                  <input id="asigTons" type="number" step="0.01" min="0">
                  <label for="asigTons">Cantidad (ton)</label>
                </div>
              </div>

              <div class="col s12">
                <div id="asigHist" class="card-panel grey lighten-4" style="padding:8px 12px">
                  <span class="grey-text">Sin asignaciones registradas.</span>
                </div>
              </div>
            </div>
            <!-- /DISPONIBILIDAD -->
          </form>
        </div>

        <div class="modal-footer" style="display:flex;justify-content:flex-end;gap:8px;">
          <button type="button" class="modal-close btn-flat">Cancelar</button>
          <button class="mmpp-button" type="submit" form="formContacto">
            <i class="material-icons left">save</i>Guardar
          </button>
        </div>
      </div>

      <div id="modalDetalleContacto" class="modal">
        <div class="modal-content">
          <h5>Detalle del contacto</h5>
          <div id="detalleContactoBody"></div>
        </div>
        <div class="modal-footer">
          <button class="mmpp-add modal-close">Cerrar</button>
        </div>
      </div>

      <!-- MODAL VISITA -->
      <div id="modalVisita" class="modal">
        <div class="modal-content">
          <h5>Registrar visita</h5>
          <form id="formVisita" autocomplete="off">
            <input type="hidden" id="visita_proveedorId">

            <div class="row">
              <div class="input-field col s4">
                <input type="date" id="visita_fecha" required>
                <label for="visita_fecha" class="active">Fecha</label>
              </div>
              <div class="input-field col s4">
                <label for="visita_centroId" class="active">Centro</label>
                <select id="visita_centroId" class="browser-default">
                  <option value="">Centro visitado (opcional)</option>
                </select>
              </div>
              <div class="input-field col s4">
                <input id="visita_contacto" type="text" placeholder="Persona contactada">
                <label for="visita_contacto">Contacto</label>
              </div>
            </div>

            <div class="row">
              <div class="input-field col s4">
                <label for="visita_enAgua" class="active">Muestra</label>
                <select id="visita_enAgua" class="browser-default">
                  <option value="">¿Toma de Muestras?</option>
                  <option>Sí</option>
                  <option>No</option>
                </select>
              </div>
              <div class="input-field col s4">
                <input id="visita_tonsComprometidas" type="number" step="0.01" min="0" placeholder="Ej: 120">
                <label for="visita_tonsComprometidas" class="active">Tons comprometidas (opcional)</label>
              </div>
              <div class="input-field col s4">
                <label for="visita_estado" class="active">Próximo paso</label>
                <select id="visita_estado" class="browser-default">
                  <option value="Programar nueva visita" selected>Nueva visita</option>
                  <option value="Tomar muestras">Tomar muestras</option>
                  <option value="Negociar precio/volumen">Negociar precio/volumen</option>
                  <option value="Contacto telefónico">Contacto telefónico</option>
                  <option value="Esperar disponibilidad">Esperar disponibilidad</option>
                  <option value="Sin acción">Sin acción</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="input-field col s4">
                <input type="date" id="visita_proximoPasoFecha">
                <label for="visita_proximoPasoFecha" class="active">Fecha exacta del próximo paso</label>
              </div>
            </div>

            <div class="input-field">
              <textarea id="visita_observaciones" class="materialize-textarea" placeholder="Hallazgos, calidad, calibres, acuerdos..."></textarea>
              <label for="visita_observaciones">Observaciones</label>
            </div>

            <div class="right-align" style="display:flex;gap:8px;justify-content:flex-end">
              <button type="button" class="modal-close btn-flat">Cancelar</button>
              <button class="mmpp-button" type="submit">
                <i class="material-icons left">save</i>Guardar visita
              </button>
            </div>
          </form>
        </div>
      </div>

      <div id="modalAsociar" class="modal">
        <div class="modal-content">
          <h5>Asociar a empresa</h5>
          <div class="input-field">
            <input id="empresaSearch" type="text" class="mmpp-input" placeholder="Buscar empresa... (mín. 2 letras)">
          </div>
          <ul id="searchResults" class="collection" style="max-height:260px;overflow:auto;"></ul>
        </div>
        <div class="modal-footer" style="display:flex;gap:8px;justify-content:flex-end">
          <a href="#!" id="btnCrearEmpresa" class="btn-flat">Crear empresa nueva</a>
          <a href="#!" id="btnQuitarEmpresa" class="btn-flat red-text">Quitar empresa</a>
          <a href="#!" class="modal-close mmpp-add">Cerrar</a>
        </div>
      </div>

    </div>
  </main>

  <!-- Libs -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>

  <!-- Orquestador -->
  <script type="module" src="../../../js/abastecimiento/contactos/index.js?v=10"></script>

  <!-- Init mínimo (tabs/modals) -->
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      var elTabs = document.querySelectorAll('.tabs');
      M.Tabs.init(elTabs, {});
      var elModals = document.querySelectorAll('.modal');
      M.Modal.init(elModals, {endingTop: '5%'});
    });
  </script>
</body>
</html>

