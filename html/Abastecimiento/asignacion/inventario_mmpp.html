<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario de MMPP – Tabla Dinámica</title>

  <!-- Materialize -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />

  <!-- Tabulator -->
  <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css">

  <style>
    body{background:#fafafa}
    nav.teal .brand-logo{font-size:1.1rem}
    .toolbar{display:grid;grid-template-columns:repeat(7,minmax(180px,1fr)) auto;gap:12px;align-items:end}
    .toolbar .input-field{margin:0}
    .card-soft{border-radius:14px;background:#fff;border:1px solid #eaeaea}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#e0f2f1;color:#00695c;font-size:.8rem}
    .right-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .footer-note{font-size:.85rem;color:#666}
    #pivotWrap{overflow-x:auto}
    .tabulator{border-radius:12px;border:1px solid #e0e0e0;min-width:680px}
    @media(max-width:1080px){.toolbar{grid-template-columns:repeat(2,minmax(180px,1fr)) auto}}
  </style>
</head>
<body>
  <nav class="teal">
    <div class="nav-wrapper container">
      <a href="#!" class="brand-logo center">Tabla Dinámica de Inventario</a>
    </div>
  </nav>

  <div class="container" style="margin-top:16px">
    <div class="card-soft" style="padding:14px;margin-bottom:12px">
      <div class="toolbar">
        <div class="input-field">
          <select id="rowDim">
            <option value="Comuna" selected>Comuna</option>
            <option value="Proveedor">Proveedor</option>
            <option value="Centro">Centro</option>
            <option value="Área">Área</option>
            <option value="Mes">Mes</option>
            <option value="Semana">Semana</option>
            <option value="Fuente">Fuente</option>
          </select>
          <label>Fila (nivel 1)</label>
        </div>

        <div class="input-field">
          <select id="subRowDim1">
            <option value="">— Ninguna —</option>
            <option value="Proveedor" selected>Proveedor</option>
            <option value="Centro">Centro</option>
            <option value="Área">Área</option>
            <option value="Comuna">Comuna</option>
            <option value="Mes">Mes</option>
            <option value="Semana">Semana</option>
            <option value="Fuente">Fuente</option>
          </select>
          <label>Subfila 1 (expandible)</label>
        </div>

        <div class="input-field">
          <select id="subRowDim2">
            <option value="">— Ninguna —</option>
            <option value="Semana">Semana</option>
            <option value="Mes">Mes</option>
            <option value="Centro">Centro</option>
            <option value="Área">Área</option>
            <option value="Proveedor">Proveedor</option>
            <option value="Comuna">Comuna</option>
            <option value="Fuente">Fuente</option>
          </select>
          <label>Subfila 2 (expandible)</label>
        </div>

        <div class="input-field">
          <select id="colDim">
            <option value="Mes" selected>Mes</option>
            <option value="Semana">Semana</option>
            <option value="Proveedor">Proveedor</option>
            <option value="Comuna">Comuna</option>
            <option value="Centro">Centro</option>
            <option value="Área">Área</option>
            <option value="Fuente">Fuente</option>
          </select>
          <label>Columna</label>
        </div>

        <div class="input-field">
          <select id="metric">
            <option value="Tons" selected>Tons</option>
            <option value="Asignado">Asignado</option>
            <option value="Saldo">Saldo</option>
          </select>
          <label>Métrica</label>
        </div>

        <div class="input-field">
          <select id="unit">
            <option value="tons" selected>Toneladas</option>
            <option value="trucks">Camiones (10 t)</option>
          </select>
          <label>Unidad</label>
        </div>

        <div class="input-field">
          <select id="agg">
            <option value="sum" selected>Suma</option>
            <option value="avg">Promedio</option>
            <option value="count">Conteo</option>
            <option value="min">Mín</option>
            <option value="max">Máx</option>
          </select>
          <label>Agregador</label>
        </div>

        <div class="right-actions">
          <a class="btn teal" id="btnApply"><i class="material-icons left">refresh</i>Aplicar</a>
          <span class="pill" id="badgeReg">0 registros</span>
          <a class="btn grey darken-2" id="btnCSV"><i class="material-icons left">download</i>CSV</a>
          <a class="btn grey darken-2" id="btnXLSX"><i class="material-icons left">file_download</i>XLSX</a>
        </div>
      </div>
    </div>

    <div id="pivotWrap">
      <div id="pivotTable"></div>
    </div>

    <div style="margin:10px 0" class="footer-note" id="unitNote">
      Unidad actual: Toneladas.
    </div>
  </div>

  <!-- Libs -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    /* ================== CONFIG ================== */
    const API_URL = 'https://backend-appmitylus.vercel.app/api';
    window.INV_ASIG_ENDPOINT = '/asignaciones/map';

    /* ================== HELPERS ================== */
    const $id = (x) => document.getElementById(x);
    const MES = ['ENE','FEB','MAR','ABR','MAY','JUN','JUL','AGO','SEP','OCT','NOV','DIC'];
    const fmt = (n) => (Number(n)||0).toLocaleString('es-CL',{maximumFractionDigits:2});

    function parseDateOrNull(d){
      if(!d && d!==0) return null;
      const s = (typeof d === 'string' && /^\d{4}-\d{2}$/.test(d)) ? (d+'-01') : d;
      const x = new Date(s);
      return (!Number.isNaN(x.getTime()) && x.getTime()!==0) ? x : null;
    }
    function monthKey(d){
      const x=parseDateOrNull(d); if(!x) return 's/fecha';
      return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}`;
    }
    function monthLabel(k){
      if(!k||k==='s/fecha') return 's/FECHA';
      const [y,m]=k.split('-'); return `${MES[+m-1]} ${y}`;
    }
    function isoWeekKey(d){
      const x=parseDateOrNull(d); if(!x) return 's/semana';
      const dt = new Date(Date.UTC(x.getFullYear(), x.getMonth(), x.getDate()));
      const dayNum = dt.getUTCDay() || 7;
      dt.setUTCDate(dt.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(dt.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((dt - yearStart)/86400000)+1)/7);
      return `${dt.getUTCFullYear()}-W${String(weekNo).padStart(2,'0')}`;
    }
    function weekLabel(k){
      if(!k || !/^(\d{4})-W(\d{2})$/.test(k)) return 's/SEM';
      const [,y,w]=k.match(/^(\d{4})-W(\d{2})$/);
      return `Sem ${w} ${y}`;
    }

    async function checkResponse(resp){
      if(!resp.ok){const text=await resp.text().catch(()=> ''); throw new Error(`HTTP ${resp.status} - ${text}`)}
      if(resp.status===204) return null; return await resp.json().catch(()=> null);
    }
    async function apiGet(path){ const r=await fetch(`${API_URL}${path}`); return checkResponse(r); }

    /* ================== DATA ================== */
    async function getOfertas(){
      const raw = await apiGet('/planificacion/ofertas');
      const arr = Array.isArray(raw?.items) ? raw.items : (Array.isArray(raw) ? raw : []);
      return arr.map(it=>{
        const fechaBase = it.fecha || it.fechaPlan || it.fch || it.mes || it.mesKey || '';
        const mes = monthKey(fechaBase);
        const semana = isoWeekKey(fechaBase);
        return {
          FechaBase: fechaBase,
          Mes: mes,
          Semana: semana,
          Proveedor: it.proveedorNombre || it.proveedor || '',
          Centro: it.centroCodigo || '',
          Área: it.areaCodigo || it.area || '',
          Comuna: it.comuna || it.centroComuna || '',
          Tons: Number(it.tons)||0,
          Fuente: it.fuente ? it.fuente[0].toUpperCase()+it.fuente.slice(1) : 'Disponibilidad'
        };
      }).filter(r=>r.Tons>0);
    }

    async function getAsignacionesMap(){
      const endpoint = (window.INV_ASIG_ENDPOINT || '').trim();
      if(!endpoint) return new Map();
      try{
        const raw=await apiGet(endpoint);
        const arr=Array.isArray(raw)?raw:(Array.isArray(raw?.items)?raw.items:[]);
        const map=new Map();
        for(const it of arr){
          const key = it.key || it.mesKey || (it.anio && it.mes ? `${it.anio}-${String(it.mes).padStart(2,'0')}` : monthKey(it.fecha || it.fechaPlan || it.fch));
          const val = Number(it.asignado ?? it.tons ?? it.total ?? it.valor ?? 0);
          if(key && Number.isFinite(val)) map.set(key, (map.get(key)||0) + val);
        }
        return map;
      }catch(_e){ return new Map(); }
    }

    function monthTotals(rows){
      const m=new Map();
      for(const r of rows){ const k=r.Mes||'s/fecha'; m.set(k,(m.get(k)||0)+(Number(r.Tons)||0)); }
      return m;
    }

    // Añade Asignado y Saldo prorrateando por participación dentro del mes
    function enrichMetrics(rows, asigMap, mTotals){
      return rows.map(r=>{
        const Tm = Number(mTotals.get(r.Mes)||0);
        const Am = Number(asigMap.get(r.Mes)||0);
        const Sm = Tm - Am;
        const factor = Tm>0 ? ((Number(r.Tons)||0)/Tm) : 0;
        const Asignado = Am*factor;
        const Saldo = Sm*factor;
        return {...r, Asignado, Saldo};
      });
    }

    /* ================== PIVOT ================== */
    const uniq = (arr)=>[...new Set(arr)];

    // rows: datos; dims: rowDim, sub1?, sub2?, colDim; metric: Tons/Asignado/Saldo; agg; unit
    function pivotData(rows, rowDim, sub1, sub2, colDim, metric, agg, unit){
      const factor = (unit === 'trucks' && agg !== 'count') ? (1/10) : 1; // 10 t por camión
      const rowKeys = uniq(rows.map(r => r[rowDim] || '(vacío)'));
      const colKeys = uniq(rows.map(r => r[colDim] || '(vacío)'));

      const aggFns = {
        sum: a => a.reduce((s,n)=>s+(Number(n)||0),0),
        avg: a => a.length? (a.reduce((s,n)=>s+(Number(n)||0),0)/a.length):0,
        count: a => a.length,
        min: a => a.length? Math.min(...a.map(n=>Number(n)||0)) : 0,
        max: a => a.length? Math.max(...a.map(n=>Number(n)||0)) : 0,
      };
      const fn = aggFns[agg] || aggFns.sum;

      const matrix = [];
      const labelField = sub2 || sub1 || rowDim;

      for(const rk of rowKeys){
        if(sub1){
          const sub1Keys = uniq(rows.filter(r => (r[rowDim]||'(vacío)')===rk).map(r => r[sub1] || '(vacío)'));
          for(const s1 of sub1Keys){
            if(sub2){
              const sub2Keys = uniq(rows.filter(r => (r[rowDim]||'(vacío)')===rk && (r[sub1]||'(vacío)')===s1).map(r => r[sub2] || '(vacío)'));
              for(const s2 of sub2Keys){
                const rowObj = {[rowDim]: rk, [sub1]: s1, [labelField]: s2};
                for(const ck of colKeys){
                  const slice = rows
                    .filter(x => (x[rowDim]||'(vacío)')===rk && (x[sub1]||'(vacío)')===s1 && (x[sub2]||'(vacío)')===s2 && (x[colDim]||'(vacío)')===ck)
                    .map(x => (agg==='count'?1:(Number(x[metric])||0)*factor));
                  rowObj[ck] = fn(slice);
                }
                rowObj['Total'] = fn(colKeys.map(ck => rowObj[ck]));
                matrix.push(rowObj);
              }
            }else{
              const rowObj = {[rowDim]: rk, [labelField]: s1};
              for(const ck of colKeys){
                const slice = rows
                  .filter(x => (x[rowDim]||'(vacío)')===rk && (x[sub1]||'(vacío)')===s1 && (x[colDim]||'(vacío)')===ck)
                  .map(x => (agg==='count'?1:(Number(x[metric])||0)*factor));
                rowObj[ck] = fn(slice);
              }
              rowObj['Total'] = fn(colKeys.map(ck => rowObj[ck]));
              matrix.push(rowObj);
            }
          }
        }else{
          const rowObj = {[rowDim]: rk, [labelField]: rk};
          for(const ck of colKeys){
            const slice = rows
              .filter(x => (x[rowDim]||'(vacío)')===rk && (x[colDim]||'(vacío)')===ck)
              .map(x => (agg==='count'?1:(Number(x[metric])||0)*factor));
            rowObj[ck] = fn(slice);
          }
          rowObj['Total'] = fn(colKeys.map(ck => rowObj[ck]));
          matrix.push(rowObj);
        }
      }

      // fila total general
      const totalRow = {[rowDim]:'Total', [labelField]:'Total'};
      for(const ck of colKeys){ totalRow[ck] = fn(matrix.map(r => r[ck])); }
      totalRow['Total'] = fn(matrix.map(r => r['Total']));
      matrix.push(totalRow);

      return {matrix, colKeys, labelField};
    }

    function prettyColTitle(colDim, key){
      if(colDim==='Mes') return monthLabel(key);
      if(colDim==='Semana') return weekLabel(key);
      return key;
    }

    function makeColumns(labelField, colKeys, colDim){
      const cols = [
        {title: labelField, field: labelField, frozen:true, headerSort:true, width: 220, minWidth:160,
          formatter:(cell)=>{
            const v = cell.getValue();
            if(labelField==='Mes' && /^\d{4}-\d{2}$/.test(v)) return monthLabel(v);
            if(labelField==='Semana' && /^\d{4}-W\d{2}$/.test(v)) return weekLabel(v);
            return v;
          }
        }
      ];
      for(const ck of colKeys){
        cols.push({ title: prettyColTitle(colDim, ck), field: ck, hozAlign:"right", headerHozAlign:"right", headerSort:true, formatter:(c)=>fmt(c.getValue()), width:120, minWidth:110 });
      }
      cols.push({title:'Total', field:'Total', hozAlign:"right", headerHozAlign:"right", headerSort:true, formatter:(c)=>fmt(c.getValue()), width:130, minWidth:110});
      return cols;
    }

    /* ================== UI / TABULATOR ================== */
    let table = null;
    let __rowsRaw = [];
    let __rowsFull = [];

    function populateSelects(){ M.FormSelect.init(document.querySelectorAll('select')); }
    function savePrefs(){
      const prefs = {
        rowDim:$id('rowDim').value, sub1:$id('subRowDim1').value, sub2:$id('subRowDim2').value,
        colDim:$id('colDim').value, metric:$id('metric').value, unit:$id('unit').value, agg:$id('agg').value,
      };
      localStorage.setItem('pivot_prefs_v3', JSON.stringify(prefs));
    }
    function loadPrefs(){
      try{
        const p=JSON.parse(localStorage.getItem('pivot_prefs_v3')||'{}');
        if(p.rowDim) $id('rowDim').value=p.rowDim;
        if(p.sub1!==undefined) $id('subRowDim1').value=p.sub1;
        if(p.sub2!==undefined) $id('subRowDim2').value=p.sub2;
        if(p.colDim) $id('colDim').value=p.colDim;
        if(p.metric) $id('metric').value=p.metric;
        if(p.unit) $id('unit').value=p.unit;
        if(p.agg) $id('agg').value=p.agg;
      }catch(_e){}
    }

    function applyPivot(){
      savePrefs();

      const rowDim   = $id('rowDim').value;
      const sub1     = $id('subRowDim1').value || '';
      const sub2     = $id('subRowDim2').value || '';
      const colDim   = $id('colDim').value;
      const metric   = $id('metric').value;
      const unit     = $id('unit').value;
      const agg      = $id('agg').value;

      const {matrix, colKeys, labelField} = pivotData(__rowsFull, rowDim, sub1, sub2, colDim, metric, agg, unit);
      const columns = makeColumns(labelField, colKeys, colDim);

      // niveles de agrupación (para expandir/contraer)
      const groupBy = (sub1 && sub2) ? [rowDim, sub1] : (sub1 ? [rowDim] : false);

      // header con totales por grupo
      const unitText = (unit==='trucks') ? ' cam.' : ' t';
      const groupHeader = function(value, count, data, group){
        // suma de columna "Total" dentro del grupo
        const total = data.reduce((s,r)=>s+(Number(r.Total)||0),0);
        const field = group.getField(); // rowDim o sub1
        // título legible
        const pretty = (field==='Mes')?monthLabel(value):(field==='Semana')?weekLabel(value):value;
        return `<span><strong>${field}:</strong> ${pretty} <span class="grey-text">(${count} ítem)</span> — <strong>Total:</strong> ${fmt(total)}${unitText}</span>`;
      };

      if(table){
        table.setGroupBy(groupBy || []);
        table.setGroupHeader(groupHeader);
        table.setColumns(columns);
        table.setData(matrix);
      }else{
        table = new Tabulator("#pivotTable", {
          data: matrix,
          columns,
          height: "70vh",
          layout: "fitColumns",             // evita crecer a la izquierda
          columnMinWidth: 110,
          resizableColumnFit: true,
          movableColumns: true,
          selectable: false,
          groupBy: groupBy || [],
          groupHeader,
          groupStartOpen: false,
          groupToggleElement: "header",
          columnDefaults:{ headerFilter:false },
          index: labelField,
        });
      }

      $id('badgeReg').textContent = `${__rowsRaw.length.toLocaleString('es-CL')} registros`;
      $id('unitNote').textContent = `Unidad actual: ${unit==='trucks' ? 'Camiones (10 t)' : 'Toneladas'}.`;
    }

    async function loadAll(){
      try{
        const [ofertas, asigMap] = await Promise.all([ getOfertas(), getAsignacionesMap() ]);
        __rowsRaw = ofertas;
        const mTotals = monthTotals(ofertas);
        __rowsFull = enrichMetrics(ofertas, asigMap, mTotals);
        applyPivot();
      }catch(e){
        console.error(e);
        M.toast?.({html:'No se pudo cargar el inventario',classes:'red'});
      }
    }

    /* ================== EVENTS ================== */
    document.addEventListener('DOMContentLoaded', ()=>{
      loadPrefs();
      populateSelects();
      setTimeout(populateSelects, 0);

      $id('btnApply').addEventListener('click', applyPivot);

      $id('btnCSV').addEventListener('click', ()=>{ if(table) table.download("csv","inventario_pivot.csv"); });
      $id('btnXLSX').addEventListener('click', ()=>{ if(table) table.download("xlsx","inventario_pivot.xlsx",{sheetName:"Pivot"}); });

      loadAll();
    });
  </script>
</body>
</html>
