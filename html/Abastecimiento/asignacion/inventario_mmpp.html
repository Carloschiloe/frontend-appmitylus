<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario de MMPP – Tabla Dinámica</title>

  <!-- Materialize (estilos básicos y toasts) -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />

  <!-- Tabulator (tabla profesional) -->
  <link rel="stylesheet" href="https://unpkg.com/tabulator-tables@5.5.2/dist/css/tabulator.min.css">

  <style>
    body{background:#fafafa}
    nav.teal .brand-logo{font-size:1.1rem}
    .toolbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center}
    .toolbar .input-field{margin:0;width:220px}
    .tabulator{border-radius:12px;border:1px solid #e0e0e0}
    .card-soft{border-radius:14px;background:#fff;border:1px solid #eaeaea}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#e0f2f1;color:#00695c;font-size:.8rem}
    .right-actions{display:flex;gap:8px;align-items:center}
    .footer-note{font-size:.85rem;color:#666}
  </style>
</head>
<body>
  <nav class="teal">
    <div class="nav-wrapper container">
      <a href="#!" class="brand-logo center">Tabla Dinámica de Inventario</a>
    </div>
  </nav>

  <div class="container" style="margin-top:16px">
    <div class="card-soft" style="padding:14px;margin-bottom:12px">
      <div class="toolbar">
        <div class="input-field">
          <select id="rowDim">
            <option value="Mes" selected>Mes</option>
            <option value="Proveedor">Proveedor</option>
            <option value="Centro">Centro</option>
            <option value="Área">Área</option>
            <option value="Comuna">Comuna</option>
            <option value="Fuente">Fuente</option>
          </select>
          <label>Fila</label>
        </div>

        <div class="input-field">
          <select id="colDim">
            <option value="Proveedor" selected>Proveedor</option>
            <option value="Mes">Mes</option>
            <option value="Centro">Centro</option>
            <option value="Área">Área</option>
            <option value="Comuna">Comuna</option>
            <option value="Fuente">Fuente</option>
          </select>
          <label>Columna</label>
        </div>

        <div class="input-field">
          <select id="metric">
            <option value="Tons" selected>Tons</option>
            <option value="Asignado">Asignado</option>
            <option value="Saldo">Saldo</option>
          </select>
          <label>Métrica</label>
        </div>

        <div class="input-field">
          <select id="agg">
            <option value="sum" selected>Suma</option>
            <option value="avg">Promedio</option>
            <option value="count">Conteo</option>
            <option value="min">Mín</option>
            <option value="max">Máx</option>
          </select>
          <label>Agregador</label>
        </div>

        <a class="btn teal" id="btnApply"><i class="material-icons left">refresh</i>Aplicar</a>

        <div class="right-actions" style="margin-left:auto">
          <span class="pill" id="badgeReg">0 registros</span>
          <a class="btn grey darken-2" id="btnCSV"><i class="material-icons left">download</i>CSV</a>
          <a class="btn grey darken-2" id="btnXLSX"><i class="material-icons left">file_download</i>XLSX</a>
        </div>
      </div>
    </div>

    <div id="pivotTable"></div>

    <div style="margin:10px 0" class="footer-note">
      Tip: reordena columnas arrastrando y ordena con click en encabezados. Doble click para auto-ajustar ancho.
    </div>
  </div>

  <!-- Libs -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="https://unpkg.com/tabulator-tables@5.5.2/dist/js/tabulator.min.js"></script>
  <!-- SheetJS para exportar XLSX desde Tabulator -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    /* ================== CONFIG ================== */
    const API_URL = 'https://backend-appmitylus.vercel.app/api';
    window.INV_ASIG_ENDPOINT = '/asignaciones/map';

    /* ================== HELPERS ================== */
    const $id = (x) => document.getElementById(x);
    const MES = ['ENE','FEB','MAR','ABR','MAY','JUN','JUL','AGO','SEP','OCT','NOV','DIC'];
    const fmt = (n) => (Number(n)||0).toLocaleString('es-CL',{maximumFractionDigits:2});

    function parseDateOrNull(d){ if(d===0||d==null||d==='') return null; const x=new Date(d); return (!Number.isNaN(x.getTime())&&x.getTime()!==0)?x:null; }
    function monthKey(d){ const x=parseDateOrNull(d); if(!x) return 's/fecha'; return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}`; }
    function monthLabel(k){ if(!k||k==='s/fecha') return 's/FECHA'; const [y,m]=k.split('-'); return `${MES[+m-1]} ${y}`; }

    async function checkResponse(resp){
      if(!resp.ok){const text=await resp.text().catch(()=> ''); throw new Error(`HTTP ${resp.status} - ${text}`)}
      if(resp.status===204) return null; return await resp.json().catch(()=> null);
    }
    async function apiGet(path){ const r=await fetch(`${API_URL}${path}`); return checkResponse(r); }

    /* ================== DATA ================== */
    async function getOfertas(){
      const raw = await apiGet('/planificacion/ofertas');
      const arr = Array.isArray(raw?.items) ? raw.items : (Array.isArray(raw) ? raw : []);
      return arr.map(it=>{
        const mes = monthKey(it.mes || it.fecha || it.mesKey || '');
        return {
          Mes: mes,
          Proveedor: it.proveedorNombre || it.proveedor || '',
          Centro: it.centroCodigo || '',
          Área: it.areaCodigo || it.area || '',
          Comuna: it.comuna || it.centroComuna || '',
          Tons: Number(it.tons)||0,
          Fuente: it.fuente ? it.fuente[0].toUpperCase()+it.fuente.slice(1) : 'Disponibilidad'
        };
      }).filter(r=>r.Tons>0);
    }

    async function getAsignacionesMap(){
      const endpoint = (window.INV_ASIG_ENDPOINT || '').trim();
      if(!endpoint) return new Map();
      try{
        const raw=await apiGet(endpoint);
        const arr=Array.isArray(raw)?raw:(Array.isArray(raw?.items)?raw.items:[]);
        const map=new Map();
        for(const it of arr){
          const key = it.key || it.mesKey || (it.anio && it.mes ? `${it.anio}-${String(it.mes).padStart(2,'0')}` : monthKey(it.fecha || it.fechaPlan || it.fch));
          const val = Number(it.asignado ?? it.tons ?? it.total ?? it.valor ?? 0);
          if(key && Number.isFinite(val)) map.set(key, (map.get(key)||0) + val);
        }
        return map;
      }catch(_e){ return new Map(); }
    }

    function monthTotals(rows){
      const m=new Map();
      for(const r of rows){ const k=r.Mes||'s/fecha'; m.set(k,(m.get(k)||0)+(Number(r.Tons)||0)); }
      return m;
    }

    // Añade Asignado y Saldo prorrateando por participación dentro del mes
    function enrichMetrics(rows, asigMap, mTotals){
      return rows.map(r=>{
        const Tm = Number(mTotals.get(r.Mes)||0);
        const Am = Number(asigMap.get(r.Mes)||0);
        const Sm = Tm - Am;
        const factor = Tm>0 ? ((Number(r.Tons)||0)/Tm) : 0;
        const Asignado = Am*factor;
        const Saldo = Sm*factor;
        return {...r, Asignado, Saldo};
      });
    }

    // Pivot simple: rowDim, colDim, metric, agg
    function pivotData(rows, rowDim, colDim, metric, agg){
      const rowKeys = [...new Set(rows.map(r=>r[rowDim] || '(vacío)'))];
      const colKeys = [...new Set(rows.map(r=>r[colDim] || '(vacío)'))];

      const aggFns = {
        sum: arr => arr.reduce((s,n)=>s+(Number(n)||0),0),
        avg: arr => arr.length? (arr.reduce((s,n)=>s+(Number(n)||0),0)/arr.length):0,
        count: arr => arr.length,
        min: arr => arr.length? Math.min(...arr.map(n=>Number(n)||0)) : 0,
        max: arr => arr.length? Math.max(...arr.map(n=>Number(n)||0)) : 0,
      };
      const fn = aggFns[agg] || aggFns.sum;

      const matrix = rowKeys.map(rk=>{
        const rowObj = {[rowDim]: rk};
        for(const ck of colKeys){
          const slice = rows.filter(x => (x[rowDim]||'(vacío)')===rk && (x[colDim]||'(vacío)')===ck)
                            .map(x => x[metric]);
          rowObj[ck] = fn(slice);
        }
        rowObj['Total'] = fn(colKeys.map(ck => rowObj[ck])); // total por fila
        return rowObj;
      });

      const totalRow = {[rowDim]:'Total'};
      for(const ck of colKeys){ totalRow[ck] = fn(matrix.map(r => r[ck])); }
      totalRow['Total'] = fn(matrix.map(r => r['Total']));
      matrix.push(totalRow);

      return {matrix, rowKeys, colKeys};
    }

    function makeColumns(rowDim, colKeys){
      const cols = [
        {title: rowDim, field: rowDim, frozen:true, headerSort:true, width: 190, formatter:(cell)=>{
          const v = cell.getValue();
          if(rowDim==='Mes' && /^\d{4}-\d{2}$/.test(v)) return monthLabel(v);
          return v;
        }}
      ];
      for(const ck of colKeys){
        cols.push({
          title: ck, field: ck, hozAlign:"right", headerHozAlign:"right",
          headerSort:true, formatter:(cell)=> (ck==='Total'? fmt(cell.getValue()): fmt(cell.getValue()))
        });
      }
      cols.push({title:'Total', field:'Total', hozAlign:"right", headerHozAlign:"right", headerSort:true,
                 formatter:(cell)=> fmt(cell.getValue())});
      return cols;
    }

    /* ================== UI / TABULATOR ================== */
    let table = null;
    let __rowsRaw = [];  // con Tons
    let __rowsFull = []; // con Asignado/Saldo

    function populateSelects(){
      M.FormSelect.init(document.querySelectorAll('select'));
    }

    function savePrefs(){
      const prefs = {
        rowDim: $id('rowDim').value,
        colDim: $id('colDim').value,
        metric: $id('metric').value,
        agg: $id('agg').value,
      };
      localStorage.setItem('pivot_prefs', JSON.stringify(prefs));
    }
    function loadPrefs(){
      try{
        const p = JSON.parse(localStorage.getItem('pivot_prefs')||'{}');
        if(p.rowDim) $id('rowDim').value = p.rowDim;
        if(p.colDim) $id('colDim').value = p.colDim;
        if(p.metric) $id('metric').value = p.metric;
        if(p.agg)    $id('agg').value    = p.agg;
      }catch(_e){}
    }

    function applyPivot(){
      savePrefs();
      const rowDim = $id('rowDim').value;
      const colDim = $id('colDim').value;
      const metric = $id('metric').value;
      const agg = $id('agg').value;

      const {matrix, colKeys} = pivotData(__rowsFull, rowDim, colDim, metric, agg);
      const columns = makeColumns(rowDim, colKeys);

      if(table){
        table.setColumns(columns);
        table.setData(matrix);
      }else{
        table = new Tabulator("#pivotTable", {
          data: matrix,
          columns,
          height: "70vh",
          layout: "fitDataStretch",
          resizableColumnFit: true,
          movableColumns: true,
          selectable: false,
          columnDefaults:{ headerFilter:false },
          index: rowDim,
        });
      }

      $id('badgeReg').textContent = `${__rowsRaw.length.toLocaleString('es-CL')} registros`;
    }

    async function loadAll(){
      try{
        const [ofertas, asigMap] = await Promise.all([ getOfertas(), getAsignacionesMap() ]);
        __rowsRaw = ofertas;
        const mTotals = monthTotals(ofertas);
        __rowsFull = enrichMetrics(ofertas, asigMap, mTotals);
        applyPivot();
      }catch(e){
        console.error(e);
        M.toast?.({html:'No se pudo cargar el inventario',classes:'red'});
      }
    }

    /* ================== EVENTS ================== */
    document.addEventListener('DOMContentLoaded', ()=>{
      loadPrefs();
      populateSelects();
      // Re-inicializa selects después de setear valores
      setTimeout(()=> populateSelects(), 0);

      $id('btnApply').addEventListener('click', applyPivot);

      $id('btnCSV').addEventListener('click', ()=>{
        if(!table) return;
        table.download("csv", "inventario_pivot.csv");
      });

      $id('btnXLSX').addEventListener('click', ()=>{
        if(!table) return;
        table.download("xlsx", "inventario_pivot.xlsx", {sheetName:"Pivot"});
      });

      loadAll();
    });
  </script>
</body>
</html>
