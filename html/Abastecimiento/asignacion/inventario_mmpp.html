<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario de MMPP (Planificaci√≥n)</title>

  <!-- Materialize & Google Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />

  <!-- DataTables + Buttons -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

  <style>
    .kpi-card{padding:12px;border-radius:10px;background:#f9fbfb;border:1px solid #e6efef}
    .kpi-title{margin:0;font-size:.9rem;color:#607d8b}
    .kpi-num{margin:.1rem 0 0;font-size:1.6rem;font-weight:700}
    .filters .input-field{margin:0}
    .w-prov{max-width:360px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .w-centro{width:110px}
    .w-comuna{max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .w-tons{text-align:right}
    .dt-buttons{margin-bottom:.4rem}
    @media (max-width: 992px){
      .w-prov{max-width:220px}
      .w-comuna{max-width:140px}
    }
  </style>
</head>
<body>

  <nav class="teal">
  <div class="nav-wrapper">
    <a href="./index.html" class="btn-flat left" title="Volver"><i class="material-icons">arrow_back</i></a>
    <a href="#" class="brand-logo center">Inventario de MMPP</a>
    </div>
</nav>


  <div class="container" style="margin-top:16px">

    <!-- Filtros -->
<div class="row filters" style="margin-bottom:10px">
  <div class="col s12 l7">
    <div class="row" style="margin-bottom:0">
      <div class="input-field col s8 m8 l8">
        <input id="fltQ" type="text" placeholder="Buscar por proveedor, c√≥digo centro o comuna‚Ä¶" />
        <label for="fltQ" class="active">B√∫squeda</label>
      </div>
      <div class="input-field col s4 m4 l4">
        <input id="fltMinTons" type="number" min="0" step="1" value="1" />
        <label for="fltMinTons" class="active">M√≠n. tons</label>
      </div>
    </div>
  </div>

  <!-- üîπ Botones a la derecha -->
  <div class="col s12 l5 right-align" style="margin-top:6px">
    <a href="./Abastecimiento/asignacion/asignacion.html"
       class="btn grey darken-1 waves-effect" id="btnIrAsignacion">
      <i class="material-icons left">assignment</i>Asignaci√≥n
    </a>
    <a id="btnBuscar" class="btn teal waves-effect">
      <i class="material-icons left">refresh</i>Actualizar
    </a>
  </div>
</div>


    <!-- KPIs -->
    <div class="row" id="kpisRow" style="margin-bottom:16px">
      <div class="col s6 m3"><div class="kpi-card center">
        <p class="kpi-title">Total tons</p><div id="kpiTons" class="kpi-num">0</div>
      </div></div>
      <div class="col s6 m3"><div class="kpi-card center">
        <p class="kpi-title">Proveedores</p><div id="kpiProvs" class="kpi-num">0</div>
      </div></div>
      <div class="col s6 m3"><div class="kpi-card center">
        <p class="kpi-title">Centros</p><div id="kpiCentros" class="kpi-num">0</div>
      </div></div>
      <div class="col s6 m3"><div class="kpi-card center">
        <p class="kpi-title">Meses</p><div id="kpiMeses" class="kpi-num">0</div>
      </div></div>
    </div>

    <!-- Gr√°fico mensual -->
    <div class="row" style="margin-bottom:18px">
      <div class="col s12">
        <canvas id="chartMeses" height="80"></canvas>
      </div>
    </div>

    <!-- Tabla -->
    <div class="row">
      <div class="col s12">
        <table id="tablaInventario" class="highlight display" style="width:100%">
          <thead>
            <tr>
              <th>Mes</th>
              <th>Proveedor</th>
              <th>C√≥digo centro</th>
              <th>Comuna</th>
              <th>Ha</th>
              <th>Tons</th>
              <th>Fuente</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Libs -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

 <script>
(() => {
  const API = 'https://backend-appmitylus-production.up.railway.app/api';

  // --- helpers ---
  const $  = (sel) => document.querySelector(sel);
  const esc = (s='') => String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;')
    .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
  const toMonth = (iso) => {
    if (!iso) return '(s/fecha)';
    // acepta 'YYYY-MM-DD' o Date/ISO
    const d = new Date(iso);
    if (Number.isNaN(d.getTime())) return String(iso).slice(0,7) || '(s/fecha)';
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
  };
  const n = (v) => Number(v) || 0;

  async function fetchJSON(url) {
    const r = await fetch(url);
    if (!r.ok) {
      const t = await r.text().catch(()=>r.statusText);
      throw new Error(`HTTP ${r.status} - ${t || r.statusText}`);
    }
    return r.json();
  }

  // --- √≠ndices de centros por c√≥digo ---
  const centrosByCode = new Map();
  function indexCentros(arr = []) {
    centrosByCode.clear();
    arr.forEach(c => {
      const code = String(c.code ?? c.codigo ?? c.Codigo ?? '').trim();
      if (!code) return;
      centrosByCode.set(code, {
        comuna:     c.comuna ?? c.Comuna ?? '',
        hectareas:  c.hectareas ?? c.Hectareas ?? c.ha ?? null
      });
    });
  }

  // KPIs
  function renderKPIs(rows) {
    const totalTons = rows.reduce((acc, r) => acc + n(r.tons), 0);
    const proveedores = new Set(rows.map(r => r.proveedor)).size;
    const centros = new Set(rows.map(r => r.codigo)).size;
    const meses = new Set(rows.map(r => r.mes)).size;

    // Ajusta estos IDs a los tuyos si difieren
    const kTotal = document.querySelector('[data-kpi="total"]') || $('#kpiTotal');
    const kProv  = document.querySelector('[data-kpi="proveedores"]') || $('#kpiProveedores');
    const kCent  = document.querySelector('[data-kpi="centros"]') || $('#kpiCentros');
    const kMeses = document.querySelector('[data-kpi="meses"]') || $('#kpiMeses');

    kTotal && (kTotal.textContent = totalTons.toLocaleString('es-CL'));
    kProv  && (kProv.textContent  = proveedores);
    kCent  && (kCent.textContent  = centros);
    kMeses && (kMeses.textContent = meses);
  }

  // --- DataTable ---
  let dt = null;
  function ensureDataTable() {
    const jq = window.jQuery || window.$;
    if (!jq) return;
    if (dt) return dt;

    dt = jq('#tablaInventario').DataTable({
      dom: 'Bfrtip',
      buttons: [
        { extend:'excelHtml5', title:'Inventario_MMPP' },
        { extend:'pdfHtml5',   title:'Inventario_MMPP', orientation:'landscape', pageSize:'A4' }
      ],
      pageLength: 10,
      autoWidth: false,
      language: { url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json' },
      order: [[0,'asc']]
    });

    // filtro r√°pido
    const bus = document.querySelector('#tablaInventario_filter input');
    const buscador = $('#buscadorTabla');
    if (buscador && bus) {
      buscador.addEventListener('input', () => {
        dt.search(buscador.value || '').draw();
      });
    }

    return dt;
  }

  function fillTable(rows) {
    const jq = window.jQuery || window.$;
    const table = $('#tablaInventario');
    if (!table || !jq) return;

    ensureDataTable();

    const data = rows.map(r => ([
      esc(r.mes),
      `<span title="${esc(r.notas || r.proveedor)}">${esc(r.proveedor)}</span>`,
      esc(r.codigo),
      esc(r.comuna || ''),
      r.ha != null ? esc(String(r.ha)) : '',
      n(r.tons).toLocaleString('es-CL'),
      esc(r.fuente || '')
    ]));

    dt.clear();
    dt.rows.add(data).draw();
  }

  // --- carga principal ---
  async function loadCentros() {
    const arr = await fetchJSON(`${API}/centros`);
    indexCentros(Array.isArray(arr) ? arr : []);
  }

  async function loadData() {
    const q = ($('#fltQ')?.value || '').trim();
    const min = Number($('#fltMinTons')?.value) || 1;

    // üîÅ Usa el endpoint existente
    const url = `${API}/contactos/disponibles?q=${encodeURIComponent(q)}&minTons=${min}`;
    const raw = await fetchJSON(url);
    const items = Array.isArray(raw) ? raw : (raw?.items || []);

    const rows = items.map(it => {
      const code = String(it.centroCodigo || '').trim();
      const info = centrosByCode.get(code) || {};
      return {
        mes: toMonth(it.fechaDisp || it.fechaDisponibilidad || null),
        proveedor: it.proveedorNombre || '',
        codigo: code,
        comuna: info.comuna || '',
        ha: info.hectareas ?? null,
        tons: n(it.tonsAprox ?? it.tonsDisponiblesAprox ?? it.tons),
        fuente: 'Contacto',
        notas: it.observaciones || ''
      };
    });

    renderKPIs(rows);
    fillTable(rows);
  }

  async function boot() {
    try {
      await loadCentros();
      await loadData();
    } catch (e) {
      console.error(e);
      alert(`Error: ${e.message}`);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // soporta ambos ids por si tu bot√≥n se llama distinto
    $('#btnBuscar')?.addEventListener('click', (e) => { e.preventDefault(); loadData().catch(console.error); });
    $('#btnActualizar')?.addEventListener('click', (e) => { e.preventDefault(); loadData().catch(console.error); });
    boot().catch(console.error);
  });
})();
</script>

</body>
</html>
