<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventario de MMPP (Planificación)</title>

  <!-- Materialize & Google Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css" />

  <!-- DataTables + Buttons -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">

  <style>
    .kpi-card{padding:12px;border-radius:10px;background:#f9fbfb;border:1px solid #e6efef}
    .kpi-title{margin:0;font-size:.9rem;color:#607d8b}
    .kpi-num{margin:.1rem 0 0;font-size:1.6rem;font-weight:700}
    .filters .input-field{margin:0}
    .w-prov{max-width:360px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .w-centro{width:110px}
    .w-comuna{max-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .w-tons{text-align:right}
    .dt-buttons{margin-bottom:.4rem}
    @media (max-width: 992px){
      .w-prov{max-width:220px}
      .w-comuna{max-width:140px}
    }
  </style>
</head>
<body>

  <nav class="teal">
    <div class="nav-wrapper">
      <a href="./index.html" class="btn-flat left" title="Volver"><i class="material-icons">arrow_back</i></a>
      <a href="#" class="brand-logo center">Inventario de MMPP</a>
    </div>
  </nav>

  <div class="container" style="margin-top:16px">

    <!-- Filtros -->
    <div class="row filters" style="margin-bottom:10px">
      <div class="col s12 l7">
        <div class="row" style="margin-bottom:0">
          <div class="input-field col s8 m8 l8">
            <input id="fltQ" type="text" placeholder="Buscar por proveedor, código centro o comuna…" />
            <label for="fltQ" class="active">Búsqueda</label>
          </div>
          <div class="input-field col s4 m4 l4">
            <input id="fltMinTons" type="number" min="0" step="1" value="1" />
            <label for="fltMinTons" class="active">Mín. tons</label>
          </div>
        </div>
      </div>
      <div class="col s12 l5 right-align" style="margin-top:6px">
        <a id="btnBuscar" class="btn teal"><i class="material-icons left">refresh</i>Actualizar</a>
      </div>
    </div>

    <!-- KPIs -->
    <div class="row" id="kpisRow" style="margin-bottom:16px">
      <div class="col s6 m3"><div class="kpi-card center">
        <p class="kpi-title">Total tons</p><div id="kpiTons" class="kpi-num">0</div>
      </div></div>
      <div class="col s6 m3"><div class="kpi-card center">
        <p class="kpi-title">Proveedores</p><div id="kpiProvs" class="kpi-num">0</div>
      </div></div>
      <div class="col s6 m3"><div class="kpi-card center">
        <p class="kpi-title">Centros</p><div id="kpiCentros" class="kpi-num">0</div>
      </div></div>
      <div class="col s6 m3"><div class="kpi-card center">
        <p class="kpi-title">Meses</p><div id="kpiMeses" class="kpi-num">0</div>
      </div></div>
    </div>

    <!-- Gráfico mensual -->
    <div class="row" style="margin-bottom:18px">
      <div class="col s12">
        <canvas id="chartMeses" height="80"></canvas>
      </div>
    </div>

    <!-- Tabla -->
    <div class="row">
      <div class="col s12">
        <table id="tablaInventario" class="highlight display" style="width:100%">
          <thead>
            <tr>
              <th>Mes</th>
              <th>Proveedor</th>
              <th>Código centro</th>
              <th>Comuna</th>
              <th>Ha</th>
              <th>Tons</th>
              <th>Fuente</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- Libs -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script>
    // Igual que en tu front:
    const API_URL = 'https://backend-appmitylus-production.up.railway.app/api';

    const $ = (sel) => document.querySelector(sel);
    const miles = (n) => (Number(n)||0).toLocaleString('es-CL');

    let dt = null;
    let chart = null;

    function initDT(){
      if (dt) return;
      dt = $('#tablaInventario') && $(window.jQuery ? '#tablaInventario' : null);
      const jq = window.jQuery || window.$;
      if (!jq) return;

      dt = jq('#tablaInventario').DataTable({
        dom: 'Bfrtip',
        buttons: [
          { extend:'excelHtml5', title:'Inventario_MMPP' },
          { extend:'pdfHtml5', title:'Inventario_MMPP', orientation:'landscape', pageSize:'A4' }
        ],
        order: [[0,'asc'], [5,'desc']],
        pageLength: 10,
        lengthMenu: [[10,25,50,100], [10,25,50,100]],
        autoWidth: false,
        language: { url:'https://cdn.datatables.net/plug-ins/1.13.8/i18n/es-ES.json' },
        columnDefs: [
          { targets: 0, width:'110px' },
          { targets: 1, className:'w-prov' },
          { targets: 2, className:'w-centro' },
          { targets: 3, className:'w-comuna' },
          { targets: 4, width:'70px' },
          { targets: 5, className:'w-tons', width:'90px' },
          { targets: 6, width:'90px' }
        ]
      });
    }

    function updateKPIs(items){
      const totalTons = items.reduce((s,r)=>s+(Number(r.tons)||0),0);
      const provs = new Set(items.map(r=>r.proveedorKey||r.proveedorNombre||''));
      const centros = new Set(items.map(r=>r.centroCodigo||''));
      const meses = new Set(items.map(r=>r.mes));

      $('#kpiTons').textContent = miles(totalTons);
      $('#kpiProvs').textContent = miles(provs.size);
      $('#kpiCentros').textContent = miles(centros.size);
      $('#kpiMeses').textContent = miles(meses.size);
    }

    function drawChart(items){
      const byMonth = {};
      for (const r of items){
        byMonth[r.mes] = (byMonth[r.mes]||0) + (Number(r.tons)||0);
      }
      const labels = Object.keys(byMonth).sort();
      const data = labels.map(m => byMonth[m]);

      const ctx = document.getElementById('chartMeses');
      if (chart){ chart.destroy(); }
      // colores por defecto (no seteamos explícitos)
      chart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Tons por mes', data }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function rowsForDT(items){
      return items.map(r => [
        r.mes,
        `<span class="w-prov" title="${escapeHtml(r.proveedorNombre)}">${escapeHtml(r.proveedorNombre)}</span>`,
        `<span class="w-centro" title="${escapeHtml(r.centroCodigo)}">${escapeHtml(r.centroCodigo)}</span>`,
        `<span class="w-comuna" title="${escapeHtml(r.comuna||'')}">${escapeHtml(r.comuna||'')}</span>`,
        r.hectareas ?? '',
        miles(r.tons),
        r.fuente || ''
      ]);
    }

    function escapeHtml(s=''){
      return String(s)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }

    async function loadData(){
      try{
        const q = $('#fltQ').value || '';
        const min = Number($('#fltMinTons').value) || 1;

        const url = `${API_URL}/plan/mes?q=${encodeURIComponent(q)}&minTons=${min}`;
        const resp = await fetch(url);
        if (!resp.ok){
          const t = await resp.text();
          throw new Error(`HTTP ${resp.status} - ${t}`);
        }
        const json = await resp.json();
        const items = Array.isArray(json?.items) ? json.items : [];

        updateKPIs(items);
        drawChart(items);

        const jq = window.jQuery || window.$;
        initDT();
        if (dt && jq){
          dt.clear();
          dt.rows.add(rowsForDT(items)).draw();
        } else {
          // fallback sin DataTables (no debería usarse)
          const tbody = document.querySelector('#tablaInventario tbody');
          tbody.innerHTML = rowsForDT(items).map(row =>
            `<tr>${row.map(td=>`<td>${td}</td>`).join('')}</tr>`
          ).join('');
        }
      }catch(err){
        console.error(err);
        M.toast?.({ html:'No se pudo cargar el inventario', classes:'red' });
      }
    }

    function hookUI(){
      document.getElementById('btnBuscar')?.addEventListener('click', loadData);
      // Enter en búsqueda
      document.getElementById('fltQ')?.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter'){ e.preventDefault(); loadData(); }
      });
      // refrescar si desde otra vista crean visita/contacto y mandan evento
      window.addEventListener('visita:created', loadData);
      window.addEventListener('contacto:created', loadData);
      window.addEventListener('contacto:updated', loadData);
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      hookUI();
      initDT();
      loadData();
    });
  </script>
</body>
</html>
