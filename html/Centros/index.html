<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Directorio de Centros Mitílidos</title>
  <base href="/" />

  <!-- CSS de terceros -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>
  <!-- Leaflet actualizado -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@2.4.0/Control.FullScreen.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/colreorder/1.5.6/css/colReorder.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css"/>

  <!-- Tus estilos -->
  <link rel="stylesheet" href="/styles.css" />
  <link rel="stylesheet" href="/css/centros.css" />

  <!-- Full-bleed helper (solo para el mapa fuera del .container) -->
  <style>
    .full-bleed{
      position:relative; left:50%; right:50%;
      margin-left:-50vw; margin-right:-50vw; width:100vw;
    }
  </style>

  <!-- Config + utils (no módulos) -->
  <script>window.DEBUG = true;</script>
  <script src="/js/config.js"></script>
  <script src="/js/utils.js"></script>
</head>
<body>
  <!-- NAV -->
  <nav class="teal">
    <div class="nav-wrapper">
      <a href="/index.html" class="btn-flat left" title="Volver" aria-label="Volver">
        <i class="material-icons">arrow_back</i>
      </a>
      <a href="#" class="brand-logo center">Directorio de Centros Mitílidos</a>
    </div>
  </nav>

  <!-- CONTENIDO -->
  <div class="container" style="margin-top:1rem;">
    <ul id="tabs" class="tabs">
      <li class="tab col s6"><a href="#tab-centros">Directorio</a></li>
      <li class="tab col s6"><a class="active" href="#tab-mapa">Mapa</a></li>
    </ul>

    <!-- TAB CENTROS -->
    <section id="tab-centros" class="col s12">
      <div class="row">
        <div class="col s12">
          <h5>Centros Registrados</h5>
          <table id="centrosTable" class="striped display responsive-table" style="width:100%">
            <thead>
              <tr>
                <th style="min-width:130px;">Proveedor</th>
                <th style="min-width:105px;">Comuna</th>
                <th style="min-width:70px;">Código</th>
                <th style="min-width:60px; max-width:80px;">Hectáreas</th>
                <th style="width:54px;">Líneas</th>
                <th style="width:60px;">Tons</th>
                <th style="width:54px;">Un/Kg</th>
                <th style="width:70px;">% Rechazo</th>
                <th style="width:56px;">Rdmto</th>
                <th style="width:48px;">Detalle</th>
                <th style="width:72px;">Acciones</th>
              </tr>
            </thead>
            <tfoot>
              <tr>
                <th colspan="3" style="text-align:right">Totales:</th>
                <th id="totalHect">0.00</th>
                <th id="totalLineas">0</th>
                <th id="totalTons">0</th>
                <th id="totalUnKg">0</th>
                <th id="totalRechazo">0</th>
                <th id="totalRdmto">0</th>
                <th colspan="2"></th>
              </tr>
            </tfoot>
          </table>
          <div id="acordeonLineas"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- TAB MAPA (full-bleed fuera del .container) -->
  <section id="tab-mapa" class="col s12 full-bleed" style="padding:0;">
    <div>
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px 6px;">
        <h5 class="map-title" style="margin:0;">Mapa de Centros</h5>
        <button id="btnFullscreenMapa" class="btn-small teal waves-effect" aria-label="Pantalla completa">
          <i class="material-icons left" style="line-height: inherit;">fullscreen</i>
          Pantalla completa
        </button>
      </div>

      <section id="mapShell" tabindex="0" aria-label="Mapa interactivo de centros"
               style="height:calc(100vh - 160px);min-height:520px;">
        <!-- Buscador (coincide con mapa.js) -->
        <div class="map-search" id="mapSearchBox">
          <input
            type="search"
            id="mapSearch"
            placeholder="Buscar por Código, Titular o Código de Área…"
            aria-label="Buscar por Código, Titular o Código de Área"
            autocomplete="off"
          />
          <ul id="mapSearchResults" class="map-search-results" role="listbox"></ul>
        </div>

        <!-- Mapa -->
        <div id="map"></div>
      </section>
    </div>
  </section>

  <!-- MODALES -->
  <div id="centroModal" class="modal"></div>
  <div id="modalDetallesCentro" class="modal" role="dialog" aria-modal="true" aria-labelledby="detallesCentroTitle" tabindex="-1">
    <div class="modal-content">
      <h5 id="detallesCentroTitle">Detalles del Centro</h5>
      <div id="detallesCentroBody"></div>
    </div>
    <div class="modal-footer">
      <button class="modal-close btn grey lighten-1">Cerrar</button>
    </div>
  </div>
  <div id="modalCoordenadas" class="modal"></div>
  <div id="modalImportarCentros" class="modal"></div>

  <!-- FABs -->
  <div style="position: fixed; bottom: 34px; right: 30px; z-index: 1030; display: flex; flex-direction: column; gap: 16px;">
    <a id="btnOpenCentroModal" class="btn-floating btn-large teal tooltipped" data-tooltip="Agregar Centro">
      <i class="material-icons">add</i>
    </a>
    <a id="btnOpenImportarModal" class="btn-floating btn-large orange darken-2 tooltipped" data-tooltip="Importar desde Excel/CSV">
      <i class="material-icons">file_upload</i>
    </a>
  </div>

  <!-- JS de terceros -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/colreorder/1.5.6/js/colReorder.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <!-- Leaflet actualizado -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.fullscreen@2.4.0/Control.FullScreen.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- App -->
  <script type="module" src="/js/app.js"></script>

  <!-- Init Materialize + fix de visibilidad del tab del mapa -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      M.Modal.init(document.querySelectorAll('.modal'));
      M.Tooltip.init(document.querySelectorAll('.tooltipped'));
      const tabsEl = document.getElementById('tabs');
      if (tabsEl) {
        const inst = M.Tabs.init(tabsEl, {
          onShow: (el) => {
            if (el && el.id === 'tab-mapa') {
              setTimeout(() => window.__mapLeaflet && window.__mapLeaflet.invalidateSize(), 60);
            }
          }
        });
        if (location.hash === '#tab-mapa' || new URLSearchParams(location.search).get('tab') === 'mapa') {
          inst.select('tab-mapa');
          setTimeout(() => window.__mapLeaflet && window.__mapLeaflet.invalidateSize(), 60);
        }
      }
    });
  </script>

  <noscript>Esta página requiere JavaScript habilitado.</noscript>
</body>
</html>
