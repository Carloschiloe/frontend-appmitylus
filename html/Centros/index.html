<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Directorio de Centros</title>

  <!-- Shell MMPP -->
  <link rel="stylesheet" href="/spa-mmpp/layout.css?v=1" />

  <!-- Tipografía Inter -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Vendor CSS -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.fullscreen@2.4.0/Control.FullScreen.css" />
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/colreorder/1.5.6/css/colReorder.dataTables.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.dataTables.min.css"/>

  <!-- Estilos de esta vista (después de vendor para poder override) -->
  <link rel="stylesheet" href="/css/centros.css?v=2" />

  <!-- Estilos mínimos para la navegación lateral -->
  <style>
    .mmpp-sidenav { display:flex; flex-direction:column; gap:.25rem; padding:.5rem; }
    .mmpp-sidenav a { display:flex; gap:.6rem; align-items:center; padding:.6rem .9rem; border-radius:.5rem; color:inherit; text-decoration:none; }
    .mmpp-sidenav a .material-icons { font-size:20px; opacity:.9; }
    .mmpp-sidenav a.active { background: rgba(255,255,255,0.08); font-weight:600; }
  </style>
</head>
<body>
  <div class="mmpp-layout">
    <!-- Sidebar con navegación a secciones -->
    <aside id="mmppNavMount" class="mmpp-nav">
      <nav class="mmpp-sidenav">
        <a href="#tab-centros" data-tab-link class="active">
          <i class="material-icons">view_list</i>
          <span>Directorio</span>
        </a>
        <a href="#tab-mapa" data-tab-link>
          <i class="material-icons">map</i>
          <span>Mapa</span>
        </a>
      </nav>
    </aside>

    <main class="mmpp-main">
      <!-- Barra superior -->
      <nav class="teal">
        <div class="nav-wrapper">
          <a href="/index.html" class="btn-flat left" title="Volver" aria-label="Volver">
            <i class="material-icons">arrow_back</i>
          </a>
          <a href="#" class="brand-logo center">Directorio de Centros Mitílidos</a>
        </div>
      </nav>

      <!-- ========= SECCIÓN: DIRECTORIO ========= -->
      <section id="tab-centros" class="col s12">
        <!-- HERO + KPIs -->
        <div class="mmpp-hero" style="margin:16px 0 12px;">
          <div><h1 style="margin:0;font-weight:800">Directorio de Centros</h1></div>
          <div class="mmpp-badge">▦ Panel</div>
        </div>

        <div class="mmpp-kpis" style="margin:10px 0 12px;">
          <div class="mmpp-kpi"><strong id="kpiCentros">0</strong>&nbsp;centros</div>
          <div class="mmpp-kpi"><strong id="kpiHect">0,00</strong>&nbsp;ha</div>
          <div class="mmpp-kpi"><strong id="kpiComunas">0</strong>&nbsp;comunas</div>
        </div>

        <!-- FILTROS -->
        <div class="mmpp-card" style="margin-bottom:12px;">
          <div class="mmpp-grid" id="filtrosCentros" style="align-items:center">
            <div>
              <select id="filtroComuna" class="mmpp-input">
                <option value="">Todas las comunas</option>
              </select>
              <div class="mmpp-help">Filtra por comuna. Los KPIs reflejan el filtro.</div>
            </div>
            <div>
              <input id="filtroProveedor" class="mmpp-input" placeholder="Buscar proveedor…" />
              <div class="mmpp-help">Busca por nombre del proveedor o código.</div>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end">
              <button id="btnLimpiarFiltros" type="button" class="mmpp-ghostbtn">Limpiar filtros</button>
            </div>
          </div>
        </div>

        <!-- TABLA -->
        <div class="row">
          <div class="col s12">
            <table id="centrosTable" class="striped display responsive-table" style="width:100%">
              <thead>
                <tr>
                  <th style="min-width:130px;">Proveedor</th>
                  <th style="min-width:105px;">Comuna</th>
                  <th style="min-width:70px;">Código</th>
                  <th style="min-width:60px;max-width:80px;">Hectáreas</th>
                  <th style="width:48px;">Detalle</th>
                  <th style="width:72px;">Acciones</th>
                </tr>
              </thead>
              <tfoot>
                <tr>
                  <th colspan="2" style="text-align:right">Totales:</th>
                  <th id="totalCentros">0</th>
                  <th id="totalHect">0,00</th>
                  <th colspan="2"></th>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </section>

      <!-- ========= SECCIÓN: MAPA ========= -->
      <section id="tab-mapa" class="col s12" style="padding:0; display:none;">
        <div>
          <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px 6px;">
            <h5 class="map-title" style="margin:0;">Mapa de Centros</h5>
            <button id="btnFullscreenMapa" class="btn-small teal waves-effect" aria-label="Pantalla completa">
              <i class="material-icons left" style="line-height:inherit;">fullscreen</i>
              Pantalla completa
            </button>
          </div>

          <section id="mapShell" tabindex="0" aria-label="Mapa interactivo de centros" style="height:calc(100vh - 160px);min-height:520px;">
            <div class="map-search" id="mapSearchBox">
              <input type="search" id="mapSearch" placeholder="Buscar por Código, Titular, Comuna o Código de Área…" aria-label="Buscar por Código, Titular, Comuna o Código de Área" autocomplete="off" />
              <ul id="mapSearchResults" class="map-search-results" role="listbox"></ul>
            </div>
            <div id="map"></div>
          </section>
        </div>
      </section>

      <!-- MODAL NUEVO/EDITAR CENTRO -->
      <div id="centroModal" class="modal modal-fixed-footer">
        <div class="modal-content">
          <h5 id="formTitle">Nuevo Centro</h5>
          <form id="formCentro">
            <input type="hidden" id="inputCentroId" />
            <div class="row">
              <div class="input-field col s12 m6">
                <input id="inputProveedor" type="text" />
                <label for="inputProveedor">Proveedor</label>
              </div>
              <div class="input-field col s12 m6">
                <input id="inputComuna" type="text" />
                <label for="inputComuna">Comuna</label>
              </div>
              <div class="input-field col s12 m4">
                <input id="inputCode" type="text" />
                <label for="inputCode">Código</label>
              </div>
              <div class="input-field col s12 m4">
                <input id="inputHectareas" type="number" step="0.01" />
                <label for="inputHectareas">Hectáreas</label>
              </div>
            </div>

            <div class="row">
              <div class="col s12"><h6>Puntos (polígono)</h6></div>
              <div class="input-field col s12 m4">
                <input id="inputLat" type="text" placeholder="Ej: 42°38'30.5&quot;S" />
                <label for="inputLat">Latitud (DMS o decimal)</label>
              </div>
              <div class="input-field col s12 m4">
                <input id="inputLng" type="text" placeholder="Ej: 73°45'12.3&quot;W" />
                <label for="inputLng">Longitud (DMS o decimal)</label>
              </div>
              <div class="col s12 m4" style="margin-top:18px;">
                <button type="button" id="btnAddPoint" class="btn teal waves-effect">
                  <i class="material-icons left">add_location</i>Agregar punto
                </button>
                <button type="button" id="btnClearPoints" class="btn-flat waves-effect">Limpiar</button>
              </div>

              <div class="col s12">
                <table id="pointsTable" class="striped">
                  <thead><tr><th>#</th><th>Lat</th><th>Lng</th><th></th></tr></thead>
                  <tbody id="pointsBody"></tbody>
                </table>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button id="btnSaveCentro" type="submit" form="formCentro" class="btn teal waves-effect">
            <i class="material-icons left">save</i>Guardar
          </button>
          <button class="modal-close btn-flat">Cancelar</button>
        </div>
      </div>

      <!-- MODAL DETALLES -->
      <div id="modalDetallesCentro" class="modal" role="dialog" aria-modal="true" aria-labelledby="detallesCentroTitle" tabindex="-1">
        <div class="modal-content">
          <h5 id="detallesCentroTitle">Detalles del Centro</h5>
          <div id="detallesCentroBody"></div>
        </div>
        <div class="modal-footer">
          <button class="modal-close btn grey lighten-1">Cerrar</button>
        </div>
      </div>

      <!-- MODAL IMPORTAR (requerido por el FAB) -->
      <div id="modalImportarCentros" class="modal modal-fixed-footer">
        <div class="modal-content">
          <h5>Importar Centros (Excel / CSV)</h5>
          <div id="importarCentrosContainer"></div>
        </div>
        <div class="modal-footer">
          <button class="modal-close btn grey lighten-1">Cerrar</button>
        </div>
      </div>

      <!-- FABs -->
      <div style="position:fixed; bottom:34px; right:30px; z-index:1030; display:flex; flex-direction:column; gap:16px;">
        <a id="btnOpenCentroModal" class="btn-floating btn-large teal tooltipped" data-tooltip="Agregar Centro">
          <i class="material-icons">add</i>
        </a>
        <a id="btnOpenImportarModal" class="btn-floating btn-large orange darken-2 tooltipped modal-trigger" data-tooltip="Importar desde Excel/CSV" href="#modalImportarCentros">
          <i class="material-icons">file_upload</i>
        </a>
      </div>
    </main>
  </div>

  <!-- JS de terceros -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/colreorder/1.5.6/js/colReorder.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.fullscreen@2.4.0/Control.FullScreen.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Utils + Config -->
  <script src="/js/config.js"></script>
  <script src="/js/utils.js"></script>

  <!-- App Centros -->
  <script type="module" src="/js/app.js"></script>

  <!-- Mini-router por hash para mostrar/ocultar secciones desde la sidebar -->
  <script>
  (function () {
    const sections = {
      '#tab-centros': document.getElementById('tab-centros'),
      '#tab-mapa': document.getElementById('tab-mapa')
    };
    const links = Array.from(document.querySelectorAll('[data-tab-link]'));

    function show(hash) {
      if (!sections[hash]) hash = '#tab-centros';

      Object.values(sections).forEach(el => el && (el.style.display = 'none'));
      sections[hash].style.display = 'block';

      links.forEach(a => a.classList.toggle('active', a.getAttribute('href') === hash));

      // Asegurar que Leaflet recalcule tamaño al abrir el mapa
      if (hash === '#tab-mapa' && window.__mapLeaflet) {
        setTimeout(() => window.__mapLeaflet.invalidateSize(), 60);
        setTimeout(() => window.__mapLeaflet.invalidateSize(), 300);
      }
    }

    window.addEventListener('hashchange', () => show(location.hash));
    if (!location.hash) location.hash = '#tab-centros';
    show(location.hash);
  })();
  </script>
</body>
</html>
